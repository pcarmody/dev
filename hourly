#!/usr/bin/ruby 

require 'csv'
require 'nokogiri'
require 'json'

list = []
list = JSON.parse(File.read(ARGV[0])) if ARGV[0]

input = `curl 'https://weather.com/weather/hourbyhour/l/94060:4:US' 2>/dev/null`
#input = `curl 'https://www.weatherforyou.com/tides/tides.php?place=pescadero%2c+CA&month=#{ARGV[0]}&year=#{ARGV[1]}' 2>/dev/null`

document = Nokogiri::HTML(input)
TIME = 1
DESCRIPTION = 2
TEMP = 3
FEELS = 4
PRECIP = 5
HUMIDITY = 6
WIND = 7

document.at('table').search('tr').each do |row|

#  next if (counter += 1) < 2

  cells = row.search('th, td').map { |cell| cell.text.strip }

#  print cells
  cell_hash = {}

# time looks like this "2:00 am\nTue"
#  cell_hash['Time'] = cells[TIME]
  time = cells[TIME].split(':')
  next if !time[1]

  hours = time[0].to_i
  am = time[1].split(' ')[1].split("\n")[0]

  if am =~ /am/i
    if hours == 12
      hours = 0
    end
  else
    if hours != 12
        hours = hours + 12
    end
  end
  cell_hash['Time'] = hours*100

  cell_hash['Description'] = cells[DESCRIPTION]
  cell_hash['Teperature'] = cells[TEMP]
  cell_hash['Feels'] = cells[FEELS]
  cell_hash['Precipitation'] = cells[PRECIP]
  cell_hash['Humidity'] = cells[HUMIDITY]
  cell_hash['Wind'] = cells[WIND]

  entry = nil
  list.each { | e | entry = e if e['Time'] == cell_hash['Time'] }

  if entry
#    print "updating #{cell_hash['Time']}\n"
    entry['Description'] = cell_hash['Description']
    entry['Teperature'] = cell_hash['Teperature']
    entry['Feels'] = cell_hash['Feels']
    entry['Precipitation'] = cell_hash['Precipitation']
    entry['Humidity'] = cell_hash['Humidity']
    entry['Wind'] = cell_hash['Wind']
  else
#    print "appending #{cell_hash['Time']}\n"
    list << cell_hash
  end

end
puts list.sort_by { |e| e['Time'] }.to_json
